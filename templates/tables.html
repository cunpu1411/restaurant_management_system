{% extends "base.html" %}

{% block title %}Table Management - Restaurant Management System{% endblock %}

{% block extra_css %}
<style>
    .table-card {
        height: auto;
        min-height: 180px;
        position: relative;
        transition: transform 0.3s;
    }
    .table-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .table-number {
        font-size: 2.5rem;
        font-weight: bold;
    }
    .table-status {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .table-info {
        position: absolute;
        bottom: 15px;
        left: 20px;
        right: 20px;
    }
    .table-capacity {
        position: absolute;
        top: 15px;
        left: 20px;
        font-size: 0.9rem;
    }
    .table-actions {
        position: absolute;
        bottom: 15px;
        right: 15px;
    }
    .table-available {
        background-color: #e8f5e9;
        border-color: #c8e6c9;
    }
    .table-occupied {
        background-color: #ffebee;
        border-color: #ffcdd2;
    }
    .table-reserved {
        background-color: #fff8e1;
        border-color: #ffecb3;
    }
    .table-card .card-footer {
        background-color: rgba(0,0,0,0.02);
        padding: 0.75rem;
        border-top: 1px solid rgba(0,0,0,0.05);
    }
    .edit-table-btn, .delete-table-btn {
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Table Management Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Table Management</h1>
        <div class="btn-toolbar">
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addTableModal">
                <i class="bi bi-plus-circle"></i> Add Table
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="viewDropdown" data-bs-toggle="dropdown">
                    View: Grid
                </button>
                <ul class="dropdown-menu" aria-labelledby="viewDropdown">
                    <li><a class="dropdown-item active" href="#" data-view="grid">Grid View</a></li>
                    <li><a class="dropdown-item" href="#" data-view="list">List View</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Table Status Filter -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="tableStatusFilter" id="allTables" value="all" checked>
                        <label class="btn btn-outline-secondary" for="allTables">All Tables</label>

                        <input type="radio" class="btn-check" name="tableStatusFilter" id="availableTables" value="available">
                        <label class="btn btn-outline-success" for="availableTables">Available</label>

                        <input type="radio" class="btn-check" name="tableStatusFilter" id="occupiedTables" value="occupied">
                        <label class="btn btn-outline-danger" for="occupiedTables">Occupied</label>

                        <input type="radio" class="btn-check" name="tableStatusFilter" id="reservedTables" value="reserved">
                        <label class="btn btn-outline-warning" for="reservedTables">Reserved</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchTables" placeholder="Search tables...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid View -->
    <div id="gridView">
        <div class="row" id="tablesContainer">
            <!-- Table cards will be dynamically loaded here -->
        </div>
    </div>

    <!-- List View -->
    <div id="listView" class="d-none">
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tablesTable">
                        <thead>
                            <tr>
                                <th>Table Number</th>
                                <th>Capacity</th>
                                <th>Status</th>
                                <th>Current Order</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be dynamically loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Table Modal -->
<div class="modal fade" id="addTableModal" tabindex="-1" aria-labelledby="addTableModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTableModalLabel">Add New Table</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTableForm" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="tableNumber" class="form-label">Table Number</label>
                        <input type="text" class="form-control" id="tableNumber" required>
                        <div class="invalid-feedback">Please enter a table number.</div>
                    </div>
                    <div class="mb-3">
                        <label for="tableCapacity" class="form-label">Capacity</label>
                        <input type="number" class="form-control" id="tableCapacity" min="1" value="4" required>
                        <div class="invalid-feedback">Capacity must be at least 1.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="tableStatus" id="statusAvailable" value="available" checked>
                                <label class="form-check-label" for="statusAvailable">Available</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="tableStatus" id="statusReserved" value="reserved">
                                <label class="form-check-label" for="statusReserved">Reserved</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="tableStatus" id="statusOutOfService" value="outofservice">
                                <label class="form-check-label" for="statusOutOfService">Out of Service</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTableBtn">Add Table</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Table Modal -->
<div class="modal fade" id="editTableModal" tabindex="-1" aria-labelledby="editTableModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTableModalLabel">Edit Table</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTableForm" class="needs-validation" novalidate>
                    <input type="hidden" id="editTableId">
                    <div class="mb-3">
                        <label for="editTableNumber" class="form-label">Table Number</label>
                        <input type="text" class="form-control" id="editTableNumber" required>
                        <div class="invalid-feedback">Please enter a table number.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editTableCapacity" class="form-label">Capacity</label>
                        <input type="number" class="form-control" id="editTableCapacity" min="1" required>
                        <div class="invalid-feedback">Capacity must be at least 1.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="editTableStatus" id="editStatusAvailable" value="available">
                                <label class="form-check-label" for="editStatusAvailable">Available</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="editTableStatus" id="editStatusOccupied" value="occupied">
                                <label class="form-check-label" for="editStatusOccupied">Occupied</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="editTableStatus" id="editStatusReserved" value="reserved">
                                <label class="form-check-label" for="editStatusReserved">Reserved</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="editTableStatus" id="editStatusOutOfService" value="outofservice">
                                <label class="form-check-label" for="editStatusOutOfService">Out of Service</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateTableBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Table Modal -->
<div class="modal fade" id="deleteTableModal" tabindex="-1" aria-labelledby="deleteTableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTableModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this table? This action cannot be undone.</p>
                <input type="hidden" id="deleteTableId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- New Order for Table Modal -->
<div class="modal fade" id="newOrderModal" tabindex="-1" aria-labelledby="newOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newOrderModalLabel">Create New Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newOrderForm" class="needs-validation" novalidate>
                    <input type="hidden" id="orderTableId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="orderWaiter" class="form-label">Waiter</label>
                            <select class="form-select" id="orderWaiter" required>
                                <option value="">Select a waiter</option>
                                <!-- Waiters will be loaded dynamically -->
                            </select>
                            <div class="invalid-feedback">Please select a waiter.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="orderCustomer" class="form-label">Customer (Optional)</label>
                            <div class="input-group mb-3">
                                <select class="form-select" id="orderCustomer">
                                    <option value="">Select a customer</option>
                                    <!-- Customers will be loaded dynamically -->
                                </select>
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#newCustomerForm">
                                    <i class="bi bi-plus"></i> New
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapse mb-3" id="newCustomerForm">
                        <div class="card card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="customerName" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="customerName">
                                </div>
                                <div class="col-md-6">
                                    <label for="customerPhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="customerPhone">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h6>Order Items</h6>
                    <div id="orderItems">
                        <div class="row mb-3 align-items-end order-item">
                            <div class="col-md-5">
                                <label for="item1" class="form-label">Item</label>
                                <select class="form-select menu-item-select" id="item1" required>
                                    <option value="">Select an item</option>
                                    <!-- Menu items will be loaded dynamically -->
                                </select>
                                <div class="invalid-feedback">Please select an item.</div>
                            </div>
                            <div class="col-md-2">
                                <label for="quantity1" class="form-label">Quantity</label>
                                <input type="number" class="form-control item-quantity" id="quantity1" min="1" value="1" required>
                                <div class="invalid-feedback">Quantity must be at least 1.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="specialRequest1" class="form-label">Special Request</label>
                                <input type="text" class="form-control special-request" id="specialRequest1" placeholder="Optional">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger remove-item">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mb-3">
                        <button type="button" class="btn btn-outline-primary" id="addItemBtn">
                            <i class="bi bi-plus-circle"></i> Add Item
                        </button>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="text-end mb-3">
                        <h5>Total: <span id="orderTotal">$0.00</span></h5>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createOrderBtn">Create Order</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load tables from API
    loadTables();
    
    // Load waiters for the new order form
    loadWaitstaff();
    
    // Load menu items for the new order form
    loadMenuItems();
    
    // View toggle
    const viewLinks = document.querySelectorAll('.dropdown-item[data-view]');
    const gridView = document.getElementById('gridView');
    const listView = document.getElementById('listView');
    
    viewLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all links
            viewLinks.forEach(l => l.classList.remove('active'));
            
            // Add active class to clicked link
            this.classList.add('active');
            
            // Update dropdown button text
            const view = this.dataset.view;
            document.getElementById('viewDropdown').textContent = 'View: ' + (view === 'grid' ? 'Grid' : 'List');
            
            // Toggle views
            if (view === 'grid') {
                gridView.classList.remove('d-none');
                listView.classList.add('d-none');
            } else {
                gridView.classList.add('d-none');
                listView.classList.remove('d-none');
            }
        });
    });
    
    // Table status filter
    const tableStatusFilters = document.querySelectorAll('input[name="tableStatusFilter"]');
    tableStatusFilters.forEach(filter => {
        filter.addEventListener('change', function() {
            const status = this.value;
            filterTables(status);
        });
    });
    
    // Table search
    const searchInput = document.getElementById('searchTables');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            searchTables(searchTerm);
        });
    }
    
    // Add table functionality
    const saveTableBtn = document.getElementById('saveTableBtn');
    if (saveTableBtn) {
        saveTableBtn.addEventListener('click', function() {
            const form = document.getElementById('addTableForm');
            
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            const tableNumber = document.getElementById('tableNumber').value;
            const capacity = document.getElementById('tableCapacity').value;
            const status = document.querySelector('input[name="tableStatus"]:checked').value;
            
            addTable(tableNumber, capacity, status);
        });
    }
    
    // Edit table functionality
    // Add this to the initializeMenuFunctions() or similar initialization function
    const updateTableBtn = document.getElementById('updateTableBtn');
    if(updateTableBtn) {
        updateTableBtn.addEventListener('click', updateTable);
    }

    // Implementation of the updateTable function
    function updateTable() {
        const tableId = document.getElementById('editTableId').value;
        const tableNumber = document.getElementById('editTableNumber').value;
        const capacity = parseInt(document.getElementById('editTableCapacity').value);
        const status = document.querySelector('input[name="editTableStatus"]:checked').value;
        // Basic validation
        if (!tableNumber || capacity < 1) {
            alert('Please fill all required fields. Capacity must be at least 1.');
            return;
        }
        
        const tableData = {
            table_number: tableNumber,
            capacity: capacity,
            status: status      // Updating status from data
        };
        
        // Get auth token from localStorage if available
        const token = localStorage.getItem('auth_token');
        const headers = {
            'Content-Type': 'application/json',
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        // Send PUT request to update the table
        fetch(`/api/v1/tables/${tableId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(tableData),
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to update table');
            }
            return response.json();
        })
        .then(data => {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTableModal'));
            modal.hide();
            
            // Show success message
            alert('Table updated successfully!');
            
            // Reload tables to reflect changes
            loadTables();
        })
        .catch(error => {
            console.error('Error updating table:', error);
            alert('Error updating table: ' + error.message);
        });
    }
    
    // Delete table functionality
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            const tableId = document.getElementById('deleteTableId').value;
            deleteTable(tableId);
        });
    }
    
    // Add item to order
    const addItemBtn = document.getElementById('addItemBtn');
    if (addItemBtn) {
        addItemBtn.addEventListener('click', function() {
            addOrderItem();
        });
    }
    
    // Create order
    const createOrderBtn = document.getElementById('createOrderBtn');
    if (createOrderBtn) {
        createOrderBtn.addEventListener('click', function() {
            const form = document.getElementById('newOrderForm');
            
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            createOrder();
        });
    }
});

// Get auth token from localStorage
function getAuthToken() {
    return localStorage.getItem('auth_token');
}

// API functions
function loadTables() {
    fetch('/api/v1/tables', {
        headers: {
            'Authorization': `Bearer ${getAuthToken()}`
        },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load tables');
        }
        return response.json();
    })
    .then(tables => {
        renderTables(tables);
    })
    .catch(error => {
        console.error('Error loading tables:', error);
        alert('Error loading tables: ' + error.message);
    });
}

function loadWaitstaff() {
    fetch('/api/v1/waitstaff', {
        headers: {
            'Authorization': `Bearer ${getAuthToken()}`
        },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load waitstaff');
        }
        return response.json();
    })
    .then(waitstaff => {
        const waiterSelect = document.getElementById('orderWaiter');
        waiterSelect.innerHTML = '<option value="">Select a waiter</option>';
        
        waitstaff.forEach(staff => {
            const option = document.createElement('option');
            option.value = staff.staff_id;
            option.textContent = staff.name;
            waiterSelect.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error loading waitstaff:', error);
    });
}

function loadMenuItems() {
    fetch('/api/v1/menu-items?available_only=true', {
        headers: {
            'Authorization': `Bearer ${getAuthToken()}`
        },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load menu items');
        }
        return response.json();
    })
    .then(menuItems => {
        const menuItemSelects = document.querySelectorAll('.menu-item-select');
        
        menuItemSelects.forEach(select => {
            select.innerHTML = '<option value="">Select an item</option>';
            
            menuItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.menu_item_id;
                option.textContent = `${item.name} - $${item.price}`;
                option.dataset.price = item.price;
                select.appendChild(option);
            });
            
            // Add change event to update total
            select.addEventListener('change', updateOrderTotal);
        });
    })
    .catch(error => {
        console.error('Error loading menu items:', error);
    });
}

function addTable(tableNumber, capacity, status) {
    const tableData = {
        table_number: tableNumber,
        capacity: parseInt(capacity)
    };
    
    fetch('/api/v1/tables/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        },
        body: JSON.stringify(tableData),
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to add table');
        }
        return response.json();
    })
    .then(newTable => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addTableModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('addTableForm').reset();
        
        // Reload tables
        loadTables();
        
        // Show success message
        alert('Table added successfully!');
    })
    .catch(error => {
        console.error('Error adding table:', error);
        alert('Error adding table: ' + error.message);
    });
}

function updateTable(tableId, tableNumber, capacity, status) {
    const tableData = {
        table_number: tableNumber,
        capacity: parseInt(capacity)
    };
    
    fetch(`/api/v1/tables/${tableId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        },
        body: JSON.stringify(tableData),
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update table');
        }
        return response.json();
    })
    .then(updatedTable => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editTableModal'));
        modal.hide();
        
        // Reload tables
        loadTables();
        
        // Show success message
        alert('Table updated successfully!');
    })
    .catch(error => {
        console.error('Error updating table:', error);
        alert('Error updating table: ' + error.message);
    });
}

function deleteTable(tableId) {
    fetch(`/api/v1/tables/${tableId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${getAuthToken()}`
        },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to delete table');
        }
        return response.json();
    })
    .then(data => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTableModal'));
        modal.hide();
        
        // Reload tables
        loadTables();
        
        // Show success message
        alert('Table deleted successfully!');
    })
    .catch(error => {
        console.error('Error deleting table:', error);
        alert('Error deleting table: ' + error.message);
    });
}

function createOrder() {
    // Get table ID
    const tableId = document.getElementById('orderTableId').value;
    
    // Get waiter ID
    const waiterId = document.getElementById('orderWaiter').value;
    
    // Get or create customer
    let customerId = document.getElementById('orderCustomer').value;
    let customerData = null;
    
    if (!customerId && document.getElementById('customerName').value) {
        customerData = {
            name: document.getElementById('customerName').value,
            contact_number: document.getElementById('customerPhone').value
        };
    }
    
    // Get order items
    const orderItems = [];
    const orderItemElements = document.querySelectorAll('.order-item');
    
    orderItemElements.forEach(itemElement => {
        const menuItemSelect = itemElement.querySelector('.menu-item-select');
        const quantityInput = itemElement.querySelector('.item-quantity');
        const specialRequestInput = itemElement.querySelector('.special-request');
        
        if (menuItemSelect.value) {
            orderItems.push({
                menu_item_id: parseInt(menuItemSelect.value),
                quantity: parseInt(quantityInput.value),
                special_request: specialRequestInput.value,
                status: 'pending'
            });
        }
    });
    
    // Create order data
    const orderData = {
        table_id: parseInt(tableId),
        waiter_id: parseInt(waiterId),
        status: 'pending',
        order_items: orderItems
    };
    
    // Add customer ID if selected
    if (customerId) {
        orderData.customer_id = parseInt(customerId);
    }
    
    // Create customer first if needed, then create order
    let createOrderPromise;
    
    if (customerData) {
        createOrderPromise = fetch('/api/v1/customers/get-or-create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(customerData),
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to create customer');
            }
            return response.json();
        })
        .then(customer => {
            orderData.customer_id = customer.customer_id;
            
            return fetch('/api/v1/orders/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(orderData),
                credentials: 'include'
            });
        });
    } else {
        createOrderPromise = fetch('/api/v1/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(orderData),
            credentials: 'include'
        });
    }
    
    createOrderPromise
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create order');
        }
        return response.json();
    })
    .then(newOrder => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('newOrderModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('newOrderForm').reset();
        
        // Reload tables
        loadTables();
        
        // Show success message and redirect to orders page
        alert('Order created successfully!');
        window.location.href = `/orders/${newOrder.order_id}`;
    })
    .catch(error => {
        console.error('Error creating order:', error);
        alert('Error creating order: ' + error.message);
    });
}

// Helper functions
function renderTables(tables) {
    const tablesContainer = document.getElementById('tablesContainer');
    const tablesTableBody = document.querySelector('#tablesTable tbody');
    
    // Clear containers
    tablesContainer.innerHTML = '';
    if (tablesTableBody) {
        tablesTableBody.innerHTML = '';
    }
    
    if (tables.length === 0) {
            tablesContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">No tables found. Click "Add Table" to create one.</div></div>';
            return;
        }
        
        // Render grid view
        tables.forEach(table => {
            const tableElement = document.createElement('div');
            tableElement.className = 'col-lg-3 col-md-4 col-sm-6 mb-4 table-item';
            tableElement.dataset.tableId = table.table_id;
            tableElement.dataset.tableNumber = table.table_number;
            
            // Use the actual status from the database
            let statusClass = 'table-available';
            let statusBadge = '<span class="badge bg-success">Available</span>';
            let orderInfo = '';
            
            // Map the status to appropriate classes and badges
            if (table.status === 'occupied') {
                statusClass = 'table-occupied';
                statusBadge = '<span class="badge bg-danger">Occupied</span>';
                orderInfo = `<small class="text-muted">Order #${Math.floor(1000 + Math.random() * 9000)}</small>`;
            } else if (table.status === 'reserved') {
                statusClass = 'table-reserved';
                statusBadge = '<span class="badge bg-warning">Reserved</span>';
                orderInfo = '<small class="text-muted">6:30 PM - John Doe</small>';
            }
            
            tableElement.innerHTML = `
                <div class="card table-card ${statusClass} shadow-sm">
                    <div class="table-capacity">
                        <i class="bi bi-person"></i> Capacity: ${table.capacity}
                    </div>
                    <div class="table-status">
                        ${statusBadge}
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div class="text-center">
                            <div class="table-number">${table.table_number}</div>
                            ${orderInfo}
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-6">
                                <button class="btn btn-sm btn-outline-primary w-100 new-order-btn" data-bs-toggle="modal" data-bs-target="#newOrderModal" data-table-id="${table.table_id}">
                                    <i class="bi bi-plus-circle"></i> New Order
                                </button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-sm btn-outline-secondary w-100 edit-table-btn" data-bs-toggle="modal" data-bs-target="#editTableModal" data-table-id="${table.table_id}">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-sm btn-outline-danger w-100 delete-table-btn" data-bs-toggle="modal" data-bs-target="#deleteTableModal" data-table-id="${table.table_id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            tablesContainer.appendChild(tableElement);
            
            // Add to list view if it exists
            if (tablesTableBody) {
                const row = document.createElement('tr');
                row.dataset.tableId = table.table_id;
                row.innerHTML = `
                    <td>${table.table_number}</td>
                    <td>${table.capacity}</td>
                    <td>${statusBadge}</td>
                    <td>${orderInfo || 'None'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary new-order-btn" data-bs-toggle="modal" data-bs-target="#newOrderModal" data-table-id="${table.table_id}">
                            <i class="bi bi-plus"></i> New Order
                        </button>
                        <button class="btn btn-sm btn-outline-secondary edit-table-btn" data-bs-toggle="modal" data-bs-target="#editTableModal" data-table-id="${table.table_id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-table-btn" data-bs-toggle="modal" data-bs-target="#deleteTableModal" data-table-id="${table.table_id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tablesTableBody.appendChild(row);
            }
        });
        
        // Add event listeners for the new order buttons
        document.querySelectorAll('.new-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tableId = this.dataset.tableId;
                document.getElementById('orderTableId').value = tableId;
                document.getElementById('newOrderModalLabel').textContent = `Create New Order - Table ${getTableNumberById(tableId)}`;
            });
        });
        
        // Add event listeners for the edit buttons
        document.querySelectorAll('.edit-table-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tableId = this.dataset.tableId;
                const table = tables.find(t => t.table_id == tableId);
                
                if (table) {
                    document.getElementById('editTableId').value = table.table_id;
                    document.getElementById('editTableNumber').value = table.table_number;
                    document.getElementById('editTableCapacity').value = table.capacity;
                    
                    // Set status (in a real app, get the actual status)
                    const statusElement = document.querySelector(`.table-item[data-table-id="${tableId}"] .badge`);
                    if (statusElement) {
                        const status = statusElement.textContent.toLowerCase();
                        document.querySelector(`input[name="editTableStatus"][value="${status === 'available' ? 'available' : status === 'occupied' ? 'occupied' : 'reserved'}"]`).checked = true;
                    } else {
                        document.getElementById('editStatusAvailable').checked = true;
                    }
                }
            });
        });
        
        // Add event listeners for the delete buttons
        document.querySelectorAll('.delete-table-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tableId = this.dataset.tableId;
                document.getElementById('deleteTableId').value = tableId;
            });
        });
    }
    
    function getTableNumberById(tableId) {
        const tableElement = document.querySelector(`.table-item[data-table-id="${tableId}"]`);
        return tableElement ? tableElement.dataset.tableNumber : '';
    }
    
    function filterTables(status) {
        const tableItems = document.querySelectorAll('.table-item');
        
        tableItems.forEach(item => {
            if (status === 'all') {
                item.style.display = '';
                return;
            }
            
            const tableStatus = item.querySelector('.badge').textContent.toLowerCase();
            
            if (status === 'available' && tableStatus === 'available') {
                item.style.display = '';
            } else if (status === 'occupied' && tableStatus === 'occupied') {
                item.style.display = '';
            } else if (status === 'reserved' && tableStatus === 'reserved') {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function searchTables(searchTerm) {
        const tableItems = document.querySelectorAll('.table-item');
        
        tableItems.forEach(item => {
            const tableNumber = item.dataset.tableNumber.toLowerCase();
            
            if (tableNumber.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function addOrderItem() {
        const orderItems = document.getElementById('orderItems');
        const itemCount = orderItems.querySelectorAll('.order-item').length + 1;
        
        const newItem = document.createElement('div');
        newItem.className = 'row mb-3 align-items-end order-item';
        newItem.innerHTML = `
            <div class="col-md-5">
                <label for="item${itemCount}" class="form-label">Item</label>
                <select class="form-select menu-item-select" id="item${itemCount}" required>
                    <option value="">Select an item</option>
                    <!-- Options will be added dynamically -->
                </select>
                <div class="invalid-feedback">Please select an item.</div>
            </div>
            <div class="col-md-2">
                <label for="quantity${itemCount}" class="form-label">Quantity</label>
                <input type="number" class="form-control item-quantity" id="quantity${itemCount}" min="1" value="1" required>
                <div class="invalid-feedback">Quantity must be at least 1.</div>
            </div>
            <div class="col-md-4">
                <label for="specialRequest${itemCount}" class="form-label">Special Request</label>
                <input type="text" class="form-control special-request" id="specialRequest${itemCount}" placeholder="Optional">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger remove-item">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        orderItems.appendChild(newItem);
        
        // Load menu items into the new select
        const menuItemSelect = newItem.querySelector('.menu-item-select');
        loadMenuItemOptions(menuItemSelect);
        
        // Add event listener for quantity change
        newItem.querySelector('.item-quantity').addEventListener('change', updateOrderTotal);
        
        // Add event listener for remove button
        newItem.querySelector('.remove-item').addEventListener('click', function() {
            if (orderItems.querySelectorAll('.order-item').length > 1) {
                this.closest('.order-item').remove();
                updateOrderTotal();
            }
        });
        
        // Add event listener for menu item selection
        menuItemSelect.addEventListener('change', updateOrderTotal);
    }
    
    function loadMenuItemOptions(selectElement) {
        // This function loads menu items into a select element
        fetch('/api/v1/menu-items?available_only=true', {
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load menu items');
            }
            return response.json();
        })
        .then(menuItems => {
            selectElement.innerHTML = '<option value="">Select an item</option>';
            
            menuItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.menu_item_id;
                option.textContent = `${item.name} - $${item.price}`;
                option.dataset.price = item.price;
                selectElement.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading menu items:', error);
        });
    }
    
    function updateOrderTotal() {
        let total = 0;
        const orderItems = document.querySelectorAll('.order-item');
        
        orderItems.forEach(item => {
            const menuItemSelect = item.querySelector('.menu-item-select');
            const quantityInput = item.querySelector('.item-quantity');
            
            if (menuItemSelect.value) {
                const selectedOption = menuItemSelect.options[menuItemSelect.selectedIndex];
                const price = parseFloat(selectedOption.dataset.price);
                const quantity = parseInt(quantityInput.value);
                
                total += price * quantity;
            }
        });
        
        document.getElementById('orderTotal').textContent = '$' + total.toFixed(2);
    }
</script>
{% endblock %}