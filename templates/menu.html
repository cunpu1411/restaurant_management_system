{% extends "base.html" %}

{% block title %}Menu Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Menu Management</h1>
    
    <!-- Category Filter -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <select id="categoryFilter" class="form-select">
                    <option value="0">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.category_id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-outline-secondary" type="button" id="filterButton">Filter</button>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-primary" id="addMenuItemButton">
                <i class="bi bi-plus-circle"></i> Add Menu Item
            </button>
        </div>
    </div>

    <!-- Menu Items List -->
    <div class="row" id="menuItemsContainer">
        {% for item in menu_items %}
        <div class="col-md-4 mb-4 menu-item" data-category="{{ item.category_id }}">
            <div class="card h-100">
                {% if item.image_url %}
                <img src="{{ item.image_url }}" class="card-img-top menu-item-image" alt="{{ item.name }}" style="height: 200px; object-fit: cover;">
                {% else %}
                <div class="card-img-top menu-item-image-placeholder text-center py-5 bg-light" style="height: 200px;">
                    <span class="d-flex align-items-center justify-content-center h-100">No Image</span>
                </div>
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ item.name }}</h5>
                    <p class="card-text">{{ item.description or 'No description' }}</p>
                    <p class="card-text"><strong>Price:</strong> ${{ item.price }}</p>
                    <p class="card-text">
                        <span class="badge {% if item.is_available %}bg-success{% else %}bg-danger{% endif %}">
                            {% if item.is_available %}Available{% else %}Unavailable{% endif %}
                        </span>
                    </p>
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100">
                        <button type="button" class="btn btn-sm btn-outline-primary edit-btn" 
                                data-id="{{ item.menu_item_id }}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning toggle-btn" 
                                data-id="{{ item.menu_item_id }}" data-available="{{ item.is_available|lower }}">
                            <i class="bi bi-toggle-on"></i> {{ 'Disable' if item.is_available else 'Enable' }}
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-btn" 
                                data-id="{{ item.menu_item_id }}">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if not menu_items %}
    <div class="alert alert-info">
        No menu items found. Click "Add Menu Item" to create one.
    </div>
    {% endif %}
</div>

<!-- Add Menu Item Modal -->
<div class="modal fade" id="addMenuItemModal" tabindex="-1" aria-labelledby="addMenuItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMenuItemModalLabel">Add New Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMenuItemForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="addName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="addName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="addDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="addPrice" class="form-label">Price</label>
                        <input type="number" class="form-control" id="addPrice" name="price" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="addCategory" class="form-label">Category</label>
                        <select class="form-select" id="addCategory" name="category_id" required>
                            {% for category in categories %}
                            <option value="{{ category.category_id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="addImage" name="image" accept="image/*">
                        <div class="form-text">Optional. Max file size: 5MB.</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="addIsAvailable" name="is_available" checked>
                        <label class="form-check-label" for="addIsAvailable">Available</label>
                    </div>
                    <div id="addErrorAlert" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addItemBtn">Add Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Menu Item Modal -->
<div class="modal fade" id="editMenuItemModal" tabindex="-1" aria-labelledby="editMenuItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMenuItemModalLabel">Edit Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMenuItemForm" enctype="multipart/form-data">
                    <input type="hidden" id="editItemId" name="menu_item_id">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPrice" class="form-label">Price</label>
                        <input type="number" class="form-control" id="editPrice" name="price" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">Category</label>
                        <select class="form-select" id="editCategory" name="category_id" required>
                            {% for category in categories %}
                            <option value="{{ category.category_id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editImage" class="form-label">Image</label>
                        <div id="currentImageContainer" class="mb-2 d-none">
                            <img id="currentImage" src="" alt="Current image" class="img-thumbnail" style="max-height: 150px;">
                        </div>
                        <input type="file" class="form-control" id="editImage" name="image" accept="image/*">
                        <div class="form-text">Leave empty to keep the current image.</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsAvailable" name="is_available">
                        <label class="form-check-label" for="editIsAvailable">Available</label>
                    </div>
                    <div id="editErrorAlert" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateItemBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this menu item? This action cannot be undone.</p>
                <input type="hidden" id="deleteItemId">
                <div id="deleteItemName" class="fw-bold text-danger mb-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Wait for the DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Menu page loaded successfully');
        
        try {
            // Setup modal for Add Menu Item button
            const addMenuItemButton = document.getElementById('addMenuItemButton');
            if(addMenuItemButton) {
                console.log('Add button found');
                addMenuItemButton.addEventListener('click', function() {
                    console.log('Add button clicked');
                    try {
                        const addModal = new bootstrap.Modal(document.getElementById('addMenuItemModal'));
                        addModal.show();
                    } catch (error) {
                        console.error('Error showing add modal:', error);
                        alert('Could not open add form. Please try again.');
                    }
                });
            }
            
            // Set up event listeners
            const filterButton = document.getElementById('filterButton');
            if(filterButton) {
                filterButton.addEventListener('click', filterByCategory);
            }
            
            const addItemBtn = document.getElementById('addItemBtn');
            if(addItemBtn) {
                addItemBtn.addEventListener('click', addMenuItem);
            }
            
            const updateItemBtn = document.getElementById('updateItemBtn');
            if(updateItemBtn) {
                updateItemBtn.addEventListener('click', updateMenuItem);
            }
            
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            if(confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', confirmDelete);
            }
            
            // Setup event listeners for edit buttons
            const editButtons = document.querySelectorAll('.edit-btn');
            console.log(`Found ${editButtons.length} edit buttons`);
            editButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.id;
                    console.log(`Edit button clicked for item ${itemId}`);
                    editMenuItem(itemId);
                });
            });
            
            // Setup event listeners for toggle buttons
            const toggleButtons = document.querySelectorAll('.toggle-btn');
            console.log(`Found ${toggleButtons.length} toggle buttons`);
            toggleButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.id;
                    console.log(`Toggle button clicked for item ${itemId}`);
                    toggleAvailability(itemId);
                });
            });
            
            // Setup event listeners for delete buttons
            const deleteButtons = document.querySelectorAll('.delete-btn');
            console.log(`Found ${deleteButtons.length} delete buttons`);
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.id;
                    const itemName = this.closest('.card').querySelector('.card-title').textContent;
                    console.log(`Delete button clicked for item ${itemId}: ${itemName}`);
                    deleteMenuItem(itemId, itemName);
                });
            });
        } catch (error) {
            console.error('Error in initialization:', error);
        }
    });

    // Filter menu items by category
    function filterByCategory() {
        console.log('Filtering by category');
        const categoryId = document.getElementById('categoryFilter').value;
        console.log(`Selected category: ${categoryId}`);
        const menuItems = document.querySelectorAll('.menu-item');
        
        let visibleCount = 0;
        menuItems.forEach(item => {
            if (categoryId === '0' || item.dataset.category === categoryId) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        console.log(`Showing ${visibleCount} items after filtering`);
    }
    
    // Add new menu item
    async function addMenuItem() {
        console.log('Adding new menu item');
        const form = document.getElementById('addMenuItemForm');
        const formData = new FormData(form);
        const errorAlert = document.getElementById('addErrorAlert');
        
        // Basic validation
        if (!formData.get('name')) {
            errorAlert.textContent = 'Name is required';
            errorAlert.classList.remove('d-none');
            return;
        }
        
        if (!formData.get('price') || parseFloat(formData.get('price')) <= 0) {
            errorAlert.textContent = 'Price must be greater than 0';
            errorAlert.classList.remove('d-none');
            return;
        }
        
        errorAlert.classList.add('d-none');
        
        // Convert form data to JSON
        const jsonData = {
            name: formData.get('name'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price')),
            category_id: parseInt(formData.get('category_id')),
            is_available: formData.get('is_available') === 'on'
        };
        
        console.log('Form data converted to JSON:', jsonData);
        
        try {
            // First create the menu item
            console.log('Sending POST request to create menu item');
            const response = await fetch('/api/v1/menu-items/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                let errorDetail = 'Failed to create menu item';
                try {
                    const errorData = await response.json();
                    errorDetail = errorData.detail || errorDetail;
                } catch (e) {}
                
                throw new Error(errorDetail);
            }
            
            const menuItem = await response.json();
            console.log('Menu item created:', menuItem);
            
            // If there's an image, upload it separately
            const imageFile = formData.get('image');
            if (imageFile && imageFile.size > 0) {
                console.log('Uploading image for new menu item');
                const imageFormData = new FormData();
                imageFormData.append('image', imageFile);
                
                const uploadResponse = await fetch(`/api/v1/menu-items/${menuItem.menu_item_id}/upload-image`, {
                    method: 'POST',
                    body: imageFormData
                });
                
                if (!uploadResponse.ok) {
                    console.error('Failed to upload image');
                } else {
                    console.log('Image uploaded successfully');
                }
            }
            
            // Hide the modal
            const addModal = bootstrap.Modal.getInstance(document.getElementById('addMenuItemModal'));
            addModal.hide();
            
            // Show success message
            alert('Menu item added successfully!');
            
            // Refresh the page to show the new item
            window.location.reload();
            
        } catch (error) {
            console.error('Error adding menu item:', error);
            errorAlert.textContent = error.message;
            errorAlert.classList.remove('d-none');
        }
    }
    
    // Edit menu item
    async function editMenuItem(itemId) {
        console.log(`Editing menu item ${itemId}`);
        const errorAlert = document.getElementById('editErrorAlert');
        errorAlert.classList.add('d-none');
        
        try {
            console.log(`Fetching menu item ${itemId} details`);
            const response = await fetch(`/api/v1/menu-items/${itemId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch menu item details');
            }
            
            const menuItem = await response.json();
            console.log('Menu item details:', menuItem);
            
            // Fill the edit form with the menu item details
            document.getElementById('editItemId').value = menuItem.menu_item_id;
            document.getElementById('editName').value = menuItem.name;
            document.getElementById('editDescription').value = menuItem.description || '';
            document.getElementById('editPrice').value = menuItem.price;
            document.getElementById('editCategory').value = menuItem.category_id;
            document.getElementById('editIsAvailable').checked = menuItem.is_available;
            
            // Show current image if available
            const imageContainer = document.getElementById('currentImageContainer');
            const currentImage = document.getElementById('currentImage');
            
            if (menuItem.image_url) {
                currentImage.src = menuItem.image_url;
                imageContainer.classList.remove('d-none');
            } else {
                imageContainer.classList.add('d-none');
            }
            
            // Open the edit modal
            const editModal = new bootstrap.Modal(document.getElementById('editMenuItemModal'));
            editModal.show();
            
        } catch (error) {
            console.error('Error fetching menu item details:', error);
            alert('Failed to load menu item details. Please try again.');
        }
    }
    
    // Update menu item
    async function updateMenuItem() {
        console.log('Updating menu item');
        const form = document.getElementById('editMenuItemForm');
        const formData = new FormData(form);
        const itemId = formData.get('menu_item_id');
        const errorAlert = document.getElementById('editErrorAlert');
        
        // Basic validation
        if (!formData.get('name')) {
            errorAlert.textContent = 'Name is required';
            errorAlert.classList.remove('d-none');
            return;
        }
        
        if (!formData.get('price') || parseFloat(formData.get('price')) <= 0) {
            errorAlert.textContent = 'Price must be greater than 0';
            errorAlert.classList.remove('d-none');
            return;
        }
        
        errorAlert.classList.add('d-none');
        console.log(`Updating menu item ${itemId}`);
        
        // Convert form data to JSON
        const jsonData = {
            name: formData.get('name'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price')),
            category_id: parseInt(formData.get('category_id')),
            is_available: formData.get('is_available') === 'on'
        };
        
        console.log('Form data converted to JSON:', jsonData);
        
        try {
            // Update the menu item
            console.log(`Sending PUT request to update menu item ${itemId}`);
            const response = await fetch(`/api/v1/menu-items/${itemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                let errorDetail = 'Failed to update menu item';
                try {
                    const errorData = await response.json();
                    errorDetail = errorData.detail || errorDetail;
                } catch (e) {}
                
                throw new Error(errorDetail);
            }
            
            console.log('Menu item updated successfully');
            
            // If there's a new image, upload it separately
            const imageFile = formData.get('image');
            if (imageFile && imageFile.size > 0) {
                console.log(`Uploading new image for menu item ${itemId}`);
                const imageFormData = new FormData();
                imageFormData.append('image', imageFile);
                
                const uploadResponse = await fetch(`/api/v1/menu-items/${itemId}/upload-image`, {
                    method: 'POST',
                    body: imageFormData
                });
                
                if (!uploadResponse.ok) {
                    console.error('Failed to upload image');
                } else {
                    console.log('Image uploaded successfully');
                }
            }
            
            // Hide the modal
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editMenuItemModal'));
            editModal.hide();
            
            // Show success message
            alert('Menu item updated successfully!');
            
            // Refresh the page to show the updated item
            window.location.reload();
            
        } catch (error) {
            console.error('Error updating menu item:', error);
            errorAlert.textContent = error.message;
            errorAlert.classList.remove('d-none');
        }
    }
    
    // Toggle availability
    async function toggleAvailability(itemId) {
        console.log(`Toggling availability for menu item ${itemId}`);
        try {
            console.log(`Sending PUT request to toggle menu item ${itemId}`);
            const response = await fetch(`/api/v1/menu-items/${itemId}/toggle-availability`, {
                method: 'PUT'
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error('Failed to toggle availability');
            }
            
            console.log('Item availability toggled successfully');
            
            // Show success message
            alert('Item availability updated successfully!');
            
            // Refresh the page to show the updated status
            window.location.reload();
            
        } catch (error) {
            console.error('Error toggling availability:', error);
            alert('Failed to update item availability. Please try again.');
        }
    }
    
    // Delete menu item - show confirmation dialog
    function deleteMenuItem(itemId, itemName) {
        console.log(`Showing delete confirmation for menu item ${itemId}`);
        document.getElementById('deleteItemId').value = itemId;
        
        // Display item name in confirmation modal if available
        const nameElement = document.getElementById('deleteItemName');
        if (nameElement && itemName) {
            nameElement.textContent = 'Item: ' + itemName;
        }
        
        const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        deleteModal.show();
    }
    
    // Confirm delete
    async function confirmDelete() {
        const itemId = document.getElementById('deleteItemId').value;
        console.log(`Confirming delete for menu item ${itemId}`);
        
        try {
            console.log(`Sending DELETE request for menu item ${itemId}`);
            const response = await fetch(`/api/v1/menu-items/${itemId}`, {
                method: 'DELETE'
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error('Failed to delete menu item');
            }
            
            console.log('Menu item deleted successfully');
            
            // Close the modal
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
            deleteModal.hide();
            
            // Show success message
            alert('Menu item deleted successfully!');
            
            // Refresh the page
            window.location.reload();
            
        } catch (error) {
            console.error('Error deleting menu item:', error);
            alert('Failed to delete menu item. Please try again.');
        }
    }
</script>
{% endblock %}